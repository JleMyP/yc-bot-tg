import json
import os
from typing import Optional, Tuple

import grpc
import telebot
import yandexcloud
from telebot.types import (
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    Update,
)
from yandex.cloud.access.access_pb2 import (
    AccessBinding,
    ListAccessBindingsRequest,
    SetAccessBindingsRequest,
    Subject,
)
from yandex.cloud.compute.v1.instance_pb2 import Instance
from yandex.cloud.compute.v1.instance_service_pb2 import (
    GetInstanceRequest,
    ListInstancesRequest,
    RestartInstanceRequest,
    StartInstanceRequest,
    StopInstanceRequest,
)
from yandex.cloud.compute.v1.instance_service_pb2_grpc import InstanceServiceStub
from yandex.cloud.mdb.postgresql.v1.cluster_pb2 import Cluster
from yandex.cloud.mdb.postgresql.v1.cluster_service_pb2 import (
    GetClusterRequest,
    ListClustersRequest,
    StartClusterRequest,
    StopClusterRequest,
)
from yandex.cloud.mdb.postgresql.v1.cluster_service_pb2_grpc import ClusterServiceStub
from yandex.cloud.serverless.functions.v1.function_pb2 import Function
from yandex.cloud.serverless.functions.v1.function_service_pb2 import (
    GetFunctionRequest,
    ListFunctionsRequest,
)
from yandex.cloud.serverless.functions.v1.function_service_pb2_grpc import FunctionServiceStub

# TODO:
#   –æ—Ç–ª–æ–≤ –æ—à–∏–±–æ–∫
#     grpc
#     —Ö–µ–Ω–¥–ª–µ—Ä—ã
#     sentry
#   git
#     auto deploy
#   –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
#   –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
#   –∫–æ–º–∞–Ω–¥—ã
#     —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ö—É–∫–∞
#     —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥
#     –≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Ö—É–∫–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–∏
#   —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏—è–º–∏
#     –≤–∫–ª/–≤—ã–∫–ª –¥–æ—Å—Ç—É–ø
#   —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª–∫–∞–º–∏
#     —Å–¥–µ–ª–∞—Ç—å ip —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º / –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º
#   —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ –≤–º
#     –≤–∫–ª / –≤—ã–∫–ª
#     –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
#   –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞
#     —é–∑–µ—Ä
#     –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–µ–≥–æ
#   –¥–æ–±–∞–≤–∏—Ç—å poll —Ä–µ–∂–∏–º
#   —Ä–µ—Å—Ç—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã
#     —Ä–∞–∑–º–æ—Ç–∞—Ç—å –ª–∞–ø—à—É –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ
#     —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º

API_TOKEN = os.getenv('TOKEN')
FOLDER = os.getenv('FOLDER')
bot = telebot.TeleBot(API_TOKEN)

INSTANCE_STATUS_EMOJI = {
    Instance.PROVISIONING: 'üîµ',
    Instance.RUNNING: '\U0001f7e2',
    Instance.STOPPING: 'üî¥',
    Instance.STOPPED: 'üî¥',
    Instance.STARTING: 'üîµ',
    Instance.RESTARTING: 'üîµ',
    Instance.UPDATING: 'üîµ',
    Instance.ERROR: '‚ùó',
    Instance.CRASHED: '‚ùóÔ∏è',
    Instance.DELETING: 'üóë',
}
CLUSTER_STATUS_EMOJI = {
    Cluster.STATUS_UNKNOWN: '‚ùî',
    Cluster.CREATING: 'üîµ',
    Cluster.RUNNING: '\U0001f7e2',
    Cluster.ERROR: '‚ùó',
    Cluster.UPDATING: 'üîµ',
    Cluster.STOPPING: 'üî¥',
    Cluster.STOPPED: 'üî¥',
    Cluster.STARTING: 'üîµ',
}
FUNCTION_STATUS_EMOJI = {
    True: '\U0001f7e2',
    False: 'üî¥',
}


def handler(event: dict, _context):
    update = Update.de_json(event['body'])
    print(update)
    bot.process_new_updates([update])
    return {
        'statusCode': 200,
    }


@bot.message_handler(commands=['start', 'help'])
def handle_help(message):
    bot.send_message(message.chat.id, 'to be continued...')


@bot.message_handler(commands=['test'])
def handle_test(message):
    mu = InlineKeyboardMarkup()
    mu.add(
        InlineKeyboardButton('button 1', callback_data='1:1'),
        InlineKeyboardButton('button 2', callback_data='2:1'),
    )
    bot.send_message(message.chat.id, 'message', reply_markup=mu)


@bot.message_handler(commands=['vms', 'vm'])
def handle_vms(message):
    sdk = yandexcloud.SDK()
    compute = sdk.client(InstanceServiceStub)
    resp = compute.List(ListInstancesRequest(folder_id=FOLDER))
    mu = InlineKeyboardMarkup()
    text = "–≤—ã–±–µ—Ä–∏ –í–ú"
    for vm in resp.instances:
        status_name = Instance.Status.Name(vm.status)
        status_emoji = INSTANCE_STATUS_EMOJI[vm.status]
        text += f'\n{status_emoji} {vm.name} {status_name}'
        if vm.status in (Instance.RUNNING, Instance.PROVISIONING, Instance.STARTING) \
                and vm.network_interfaces:
            net = vm.network_interfaces[0].primary_v4_address
            if net.one_to_one_nat:
                text += f' {net.one_to_one_nat.address}'
        mu.add(
            InlineKeyboardButton(vm.name, callback_data=f'vm:{vm.id}'),
        )
    bot.send_message(message.chat.id, text, reply_markup=mu)


@bot.message_handler(commands=['func'])
def handle_funcs(message):
    sdk = yandexcloud.SDK()
    functions = sdk.client(FunctionServiceStub)
    resp = functions.List(ListFunctionsRequest(folder_id=FOLDER))
    mu = InlineKeyboardMarkup()
    for func in resp.functions:
        resp_b = functions.ListAccessBindings(ListAccessBindingsRequest(resource_id=func.id))
        status_emoji = FUNCTION_STATUS_EMOJI[bool(resp_b.access_bindings)]
        mu.add(
            InlineKeyboardButton(f'{status_emoji} {func.name}', callback_data=f'func:{func.id}'),
        )
    bot.send_message(message.chat.id, '–≤—ã–±–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏—é', reply_markup=mu)


@bot.message_handler(commands=['cluster'])
def handle_dbs(message):
    sdk = yandexcloud.SDK()
    clusters = sdk.client(ClusterServiceStub)
    resp = clusters.List(ListClustersRequest(folder_id=FOLDER))
    mu = InlineKeyboardMarkup()
    text = "–≤—ã–±–µ—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä"
    for cluster in resp.clusters:
        status_name = Cluster.Status.Name(cluster.status)
        status_emoji = CLUSTER_STATUS_EMOJI[cluster.status]
        text += f'\n{status_emoji} {cluster.name} {status_name}'
        # TODO: —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        # –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ö–æ—Å—Ç–æ–≤, –Ω–∞–π—Ç–∏ –º–∞—Å—Ç–µ—Ä–∞
        # –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–¥
        mu.add(
            InlineKeyboardButton(cluster.name, callback_data=f'cluster:{cluster.id}'),
        )
    bot.send_message(message.chat.id, text, reply_markup=mu)


@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    cmd, arg = call.data.split(':')
    if cmd == 'vm':
        vm, error = get_vm(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –í–ú {arg}\n\n{error}", call.message.chat.id,
                                  call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            mu = InlineKeyboardMarkup()
            mu.add(
                InlineKeyboardButton('‚ñ∂ start', callback_data=f'vm-start:{arg}'),
                InlineKeyboardButton('‚èπ stop', callback_data=f'vm-stop:{arg}'),
                InlineKeyboardButton('‚èØ restart', callback_data=f'vm-restart:{arg}'),
            )
            bot.answer_callback_query(call.id)
            bot.edit_message_text(vm.name, call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id,
                                          reply_markup=mu)
    elif cmd == 'vm-start':
        error = start_vm(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –í–ú {arg}\n\n{error}", call.message.chat.id,
                                  call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–í–ú {arg} –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è", call.message.chat.id,
                                  call.message.message_id)
    elif cmd == 'vm-stop':
        error = stop_vm(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –í–ú {arg}\n\n{error}",
                                  call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–í–ú {arg} –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è", call.message.chat.id,
                                  call.message.message_id)
    elif cmd == 'vm-restart':
        error = restart_vm(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –í–ú {arg}\n\n{error}",
                                  call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–í–ú {arg} –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è", call.message.chat.id,
                                  call.message.message_id)
    elif cmd == 'cluster':
        # –ø–æ–ª—É—á–∏—Ç—å —Ö–æ—Å—Ç—ã, –Ω–∞–π—Ç–∏ –º–∞—Å—Ç–µ—Ä–∞
        # –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–¥
        # –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç / —Å—Ç–æ–ø
        cluster, error = get_cluster(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä {arg}\n\n{error}",
                                  call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            mu = InlineKeyboardMarkup()
            mu.add(
                InlineKeyboardButton('‚ñ∂ start', callback_data=f'cluster-start:{arg}'),
                InlineKeyboardButton('‚èπ stop', callback_data=f'cluster-stop:{arg}'),
            )
            bot.answer_callback_query(call.id)
            bot.edit_message_text(cluster.name, call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id,
                                          reply_markup=mu)
    elif cmd == 'cluster-start':
        error = start_cluster(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä {arg}\n\n{error}",
                                  call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–∫–ª–∞—Å—Ç–µ—Ä {arg} –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è", call.message.chat.id,
                                  call.message.message_id)
    elif cmd == 'cluster-stop':
        error = stop_cluster(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä {arg}\n\n{error}",
                                  call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–∫–ª–∞—Å—Ç–µ—Ä {arg} –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è", call.message.chat.id,
                                  call.message.message_id)
    elif cmd == 'func':
        func, error = get_func(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é {arg}\n\n{error}",
                                  call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            mu = InlineKeyboardMarkup()
            mu.add(
                InlineKeyboardButton('open access', callback_data=f'func-open:{arg}'),
                InlineKeyboardButton('close access', callback_data=f'func-close:{arg}'),
            )
            bot.answer_callback_query(call.id)
            bot.edit_message_text(func.name, call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id,
                                          reply_markup=mu)
    elif cmd == 'func-open':
        error = open_func(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏—é {arg}\n\n{error}",
                                  call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"—Ñ—É–Ω–∫—Ü–∏—è {arg} –æ—Ç–∫—Ä—ã—Ç–∞", call.message.chat.id,
                                  call.message.message_id)
    elif cmd == 'func-close':
        error = close_func(arg)
        if error:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏—é {arg}\n\n{error}",
                                  call.message.chat.id, call.message.message_id)
            bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id)
        else:
            bot.answer_callback_query(call.id)
            bot.edit_message_text(f"—Ñ—É–Ω–∫—Ü–∏—è {arg} –∑–∞–∫—Ä—ã—Ç–∞", call.message.chat.id,
                                  call.message.message_id)
    else:
        bot.answer_callback_query(call.id, call.data)
        bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id,
                                      reply_markup=None)
        bot.send_message(call.message.chat.id, call.data)


def get_vm(vm_id: str) -> Tuple[Instance, Optional[str]]:
    sdk = yandexcloud.SDK()
    client = sdk.client(InstanceServiceStub)
    try:
        return client.Get(GetInstanceRequest(instance_id=vm_id)), None
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return None, e.details()
        return None, json.dumps(e.args)


def start_vm(vm_id: str) -> Optional[str]:
    sdk = yandexcloud.SDK()
    client = sdk.client(InstanceServiceStub)
    try:
        client.Start(StartInstanceRequest(instance_id=vm_id))
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return e.details()
        return json.dumps(e.args)


def stop_vm(vm_id: str) -> Optional[str]:
    sdk = yandexcloud.SDK()
    client = sdk.client(InstanceServiceStub)
    try:
        client.Stop(StopInstanceRequest(instance_id=vm_id))
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return e.details()
        return json.dumps(e.args)


def restart_vm(vm_id: str) -> Optional[str]:
    sdk = yandexcloud.SDK()
    client = sdk.client(InstanceServiceStub)
    try:
        client.Restart(RestartInstanceRequest(instance_id=vm_id))
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return e.details()
        return json.dumps(e.args)


def get_cluster(cluster_id: str) -> Tuple[Cluster, Optional[str]]:
    sdk = yandexcloud.SDK()
    client = sdk.client(ClusterServiceStub)
    try:
        return client.Get(GetClusterRequest(cluster_id=cluster_id)), None
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return None, e.details()
        return None, json.dumps(e.args)


def start_cluster(cluster_id: str) -> Optional[str]:
    sdk = yandexcloud.SDK()
    client = sdk.client(ClusterServiceStub)
    try:
        client.Start(StartClusterRequest(cluster_id=cluster_id))
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return e.details()
        return json.dumps(e.args)


def stop_cluster(cluster_id: str) -> Optional[str]:
    sdk = yandexcloud.SDK()
    client = sdk.client(ClusterServiceStub)
    try:
        client.Stop(StopClusterRequest(cluster_id=cluster_id))
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return e.details()
        return json.dumps(e.args)


def get_func(func_id: str) -> Tuple[Function, Optional[str]]:
    sdk = yandexcloud.SDK()
    client = sdk.client(FunctionServiceStub)
    try:
        return client.Get(GetFunctionRequest(function_id=func_id)), None
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return None, e.details()
        return None, json.dumps(e.args)


def open_func(func_id: str) -> Optional[str]:
    sdk = yandexcloud.SDK()
    client = sdk.client(FunctionServiceStub)
    try:
        client.SetAccessBindings(SetAccessBindingsRequest(
            resource_id=func_id,
            access_bindings=[
                AccessBinding(
                    role_id='serverless.functions.invoker',
                    subject=Subject(
                        id='allUsers',
                        type='system',
                    ),
                ),
            ],
        ))
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return e.details()
        return json.dumps(e.args)


def close_func(func_id: str) -> Optional[str]:
    sdk = yandexcloud.SDK()
    client = sdk.client(FunctionServiceStub)
    try:
        client.SetAccessBindings(SetAccessBindingsRequest(
            resource_id=func_id,
            access_bindings=[],
        ))
    except grpc.RpcError as e:
        if hasattr(e, 'details'):
            return e.details()
        return json.dumps(e.args)
